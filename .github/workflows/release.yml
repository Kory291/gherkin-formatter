name: Create release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate_changelog:
    name: Create and commit generate changelog
    runs-on: ubuntu-latest
    container:
      image: quay.io/git-chglog/git-chglog:latest
      # volumes:
      #   - .:/workdir
    steps:
      - name: Create changelog
        run: |
          ls -la
          pwd
          git-chglog --output CHANGELOG.md
      - name: Commit changes to main
        env:
          tag: ${{ github.ref_name }}
        run: |
          git checkout main
          git add CHANGELOG.md
          git commit -m "chore(new-version): update changelog for $tag"
          git push
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release create $tag --generate-notes --repo="$GITHUB_REPOSITORY" --title="${GITHUB_REPOSITORY#/} ${tag#v}" --generate-notes
